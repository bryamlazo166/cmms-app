<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Gerencial - CMMS</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/sidebar.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-section {
            background: #252526;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none;
            /* Hidden by default */
            animation: fadeIn 0.5s ease-in-out;
        }

        .report-header {
            border-bottom: 2px solid #03dac6;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .report-title {
            margin: 0;
            color: #fff;
            font-size: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .report-subtitle {
            margin: 5px 0 0 0;
            color: #aaa;
            font-size: 0.9rem;
        }

        .kpi-row {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .kpi-card-mini {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            flex: 1;
            border: 1px solid #333;
        }

        .kpi-val-mini {
            font-size: 1.5em;
            font-weight: bold;
        }

        .kpi-lbl-mini {
            font-size: 0.8em;
            color: #888;
            text-transform: uppercase;
        }

        .clickable-row {
            cursor: pointer;
            transition: background 0.2s;
        }

        .clickable-row:hover {
            background: #333 !important;
        }

        .selected-row {
            background: #37474f !important;
            border-left: 4px solid #03dac6;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media print {

            .main-header,
            .toolbar,
            .no-print {
                display: none !important;
            }

            .report-section {
                display: block !important;
                break-inside: avoid;
                border: 1px solid #ccc;
                background: white;
                color: black;
                box-shadow: none;
            }

            body {
                background: white;
                color: black;
            }

            .report-title {
                color: #000;
            }

            .kpi-card-mini {
                background: #f0f0f0;
                border: 1px solid #ddd;
            }

            table {
                color: black;
                border-collapse: collapse;
            }

            th,
            td {
                border: 1px solid #ddd;
            }
        }
    </style>
</head>

<body>
    <nav class="sidebar">
        <div class="logo-details">
            <i class="fas fa-industry icon"></i>
            <div class="logo_name">CMMS Pro</div>
            <i class="fas fa-bars" id="btn_toggle"></i>
        </div>
        <ul class="nav-list">
            <li>
                <a href="/">
                    <i class="fas fa-chart-line"></i>
                    <span class="links_name">Dashboard</span>
                </a>
                <span class="tooltip">Dashboard</span>
            </li>
            <li>
                <a href="/avisos">
                    <i class="fas fa-bell"></i>
                    <span class="links_name">Avisos</span>
                </a>
                <span class="tooltip">Avisos</span>
            </li>
            <li>
                <a href="/ordenes">
                    <i class="fas fa-tools"></i>
                    <span class="links_name">Órdenes</span>
                </a>
                <span class="tooltip">Órdenes</span>
            </li>
            <li>
                <a href="/compras">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="links_name">Compras</span>
                </a>
                <span class="tooltip">Compras</span>
            </li>
            <li>
                <a href="/almacen">
                    <i class="fas fa-boxes"></i>
                    <span class="links_name">Almacén</span>
                </a>
                <span class="tooltip">Almacén</span>
            </li>
            <li>
                <a href="/configuracion">
                    <i class="fas fa-sitemap"></i>
                    <span class="links_name">Activos</span>
                </a>
                <span class="tooltip">Activos</span>
            </li>
            <li>
                <a href="/reportes">
                    <i class="fas fa-file-contract"></i>
                    <span class="links_name">Reportes</span>
                </a>
                <span class="tooltip">Reportes</span>
            </li>
        </ul>
    </nav>
    <section class="home-section">
        <div class="top-bar">
            <h1><i class="fas fa-file-contract"></i> Informe de Gestión de Activos</h1>
        </div>
        <div class="main-container">

            <div class="container-fluid">
                <!-- GLOBAL CONTROLS -->
                <div class="toolbar"
                    style="background: #1e1e1e; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                    <div style="display: flex; gap: 20px; align-items: end;">
                        <div>
                            <label>Fecha Inicio</label>
                            <input type="date" id="startDate">
                        </div>
                        <div>
                            <label>Fecha Fin</label>
                            <input type="date" id="endDate">
                        </div>
                        <button class="btn-primary" onclick="loadLevel1()">
                            <i class="fas fa-sync"></i> Generar Reporte
                        </button>
                        <button class="btn-secondary" onclick="window.print()">
                            <i class="fas fa-print"></i> Imprimir / PDF
                        </button>
                    </div>
                </div>

                <!-- LEVEL 1: CORPORATE / AREAS -->
                <section id="sectionLevel1" class="report-section" style="display: block;">
                    <div class="report-header">
                        <h2 class="report-title">1. Panorama Corporativo (Áreas)</h2>
                        <p class="report-subtitle">Comparativo de desempeño entre áreas operativas principales.</p>
                    </div>

                    <div class="kpi-row" id="kpisLevel1">
                        <!-- Injected via JS -->
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <div class="table-container" style="height: auto; max-height: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Área</th>
                                        <th>Disponibilidad</th>
                                        <th>MTBF (hrs)</th>
                                        <th>Gasto ($)</th>
                                        <th>Ver Detalle</th>
                                    </tr>
                                </thead>
                                <tbody id="tableLevel1">
                                    <!-- JS populated -->
                                </tbody>
                            </table>
                        </div>
                        <div style="height: 300px;">
                            <canvas id="chartLevel1"></canvas>
                        </div>
                    </div>
                </section>

                <!-- LEVEL 2: TACTICAL / LINES -->
                <section id="sectionLevel2" class="report-section">
                    <div class="report-header">
                        <h2 class="report-title" id="titleLevel2">2. Análisis Táctico</h2>
                        <p class="report-subtitle">Desglose de desempeño por Líneas de Producción.</p>
                    </div>

                    <div class="kpi-row" id="kpisLevel2"></div>

                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                        <div style="height: 300px;">
                            <canvas id="chartLevel2"></canvas>
                        </div>
                        <div class="table-container" style="height: auto; max-height: none;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Línea</th>
                                        <th>Disponibilidad</th>
                                        <th>MTBF</th>
                                        <th>MTTR</th>
                                        <th>Costo</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tableLevel2"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- LEVEL 3: OPERATIONAL / EQUIPMENT -->
                <section id="sectionLevel3" class="report-section">
                    <div class="report-header">
                        <h2 class="report-title" id="titleLevel3">3. Detalle Operativo</h2>
                        <p class="report-subtitle">Listado de Equipos y Activos Críticos (Bad Actors).</p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #f44336; border-bottom: 1px solid #f44336; display: inline-block;">⚠️ Bad
                            Actors (Top
                            Fallas & Costo)</h3>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Equipo / Activo</th>
                                <th>No. de Fallas</th>
                                <th>Tiempo Fuera (h)</th>
                                <th>Costo ($)</th>
                                <th>Disponibilidad</th>
                                <th>MTBF</th>
                            </tr>
                        </thead>
                        <tbody id="tableLevel3"></tbody>
                    </table>
                </section>

            </div>

            <script>
                // State
                let chartInstance1 = null;
                let chartInstance2 = null;
                let selectedAreaId = null;
                let selectedLineId = null;

                document.addEventListener('DOMContentLoaded', () => {
                    const end = new Date();
                    const start = new Date();
                    start.setDate(start.getDate() - 30);

                    document.getElementById('endDate').valueAsDate = end;
                    document.getElementById('startDate').valueAsDate = start;

                    loadLevel1();
                });

                // --- LEVEL 1: AREAS ---
                async function loadLevel1() {
                    // Hide lower levels
                    document.getElementById('sectionLevel2').style.display = 'none';
                    document.getElementById('sectionLevel3').style.display = 'none';

                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;

                    const res = await fetch(`/api/reports/kpis?start_date=${start}&end_date=${end}`);
                    const data = await res.json();

                    if (data.error) { alert(data.error); return; }

                    // Render KPIs
                    renderKPIs('kpisLevel1', data.groups);

                    // Render Table
                    const tbody = document.getElementById('tableLevel1');
                    tbody.innerHTML = data.groups.map(g => `
                <tr class="clickable-row" onclick="selectArea(${g.id}, '${g.name}', this)">
                    <td><strong>${g.name}</strong></td>
                    <td>${g.availability.toFixed(1)}%</td>
                    <td>${g.mtbf.toFixed(0)}</td>
                    <td>$${g.cost.toLocaleString()}</td>
                    <td><button class="btn-icon"><i class="fas fa-arrow-right"></i></button></td>
                </tr>
            `).join('');

                    // Render Chart
                    renderChart('chartLevel1', data.groups, 'availability', 'Disponibilidad %');
                }

                async function selectArea(id, name, rowElem) {
                    selectedAreaId = id;

                    // Highlight row
                    document.querySelectorAll('#tableLevel1 tr').forEach(r => r.classList.remove('selected-row'));
                    rowElem.classList.add('selected-row');

                    // Load Level 2
                    await loadLevel2(id, name);
                }

                // --- LEVEL 2: LINES ---
                async function loadLevel2(areaId, areaName) {
                    document.getElementById('sectionLevel2').style.display = 'block';
                    document.getElementById('sectionLevel3').style.display = 'none';

                    // Scroll to section
                    document.getElementById('sectionLevel2').scrollIntoView({ behavior: 'smooth' });

                    document.getElementById('titleLevel2').innerText = `2. Análisis Táctico - ${areaName}`;

                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;

                    const res = await fetch(`/api/reports/kpis?start_date=${start}&end_date=${end}&area_id=${areaId}`);
                    const data = await res.json();

                    renderKPIs('kpisLevel2', data.groups);

                    const tbody = document.getElementById('tableLevel2');
                    tbody.innerHTML = data.groups.map(g => `
                <tr class="clickable-row" onclick="selectLine(${g.id}, '${g.name}', this)">
                    <td>${g.name}</td>
                    <td><span class="badge ${g.availability > 95 ? 'stock-ok' : 'stock-critical'}">${g.availability}%</span></td>
                    <td>${g.mtbf.toFixed(0)}</td>
                    <td>${g.mttr.toFixed(1)}</td>
                    <td>$${g.cost.toLocaleString()}</td>
                    <td><i class="fas fa-search"></i></td>
                </tr>
            `).join('');

                    renderChart('chartLevel2', data.groups, 'cost', 'Costo $'); // Cost chart for lines
                }

                async function selectLine(id, name, rowElem) {
                    selectedLineId = id;
                    // Highlight row
                    document.querySelectorAll('#tableLevel2 tr').forEach(r => r.classList.remove('selected-row'));
                    rowElem.classList.add('selected-row');

                    await loadLevel3(id, name);
                }

                // --- LEVEL 3: EQUIPMENTS ---
                async function loadLevel3(lineId, lineName) {
                    document.getElementById('sectionLevel3').style.display = 'block';
                    document.getElementById('sectionLevel3').scrollIntoView({ behavior: 'smooth' });

                    document.getElementById('titleLevel3').innerText = `3. Detalle Operativo - ${lineName}`;

                    const start = document.getElementById('startDate').value;
                    const end = document.getElementById('endDate').value;

                    const res = await fetch(`/api/reports/kpis?start_date=${start}&end_date=${end}&line_id=${lineId}`);
                    const data = await res.json();

                    // Sort by bad actors (Availability ASC, Cost DESC)
                    const sorted = data.groups.sort((a, b) => a.availability - b.availability || b.cost - a.cost);

                    const tbody = document.getElementById('tableLevel3');
                    tbody.innerHTML = sorted.map(g => `
                <tr>
                    <td><strong>${g.name}</strong></td>
                    <td>${g.failures}</td>
                    <td>${(g.failures * g.mttr).toFixed(1)}</td>
                    <td>$${g.cost.toLocaleString()}</td>
                    <td style="color:${g.availability < 90 ? '#f44336' : '#4caf50'}">${g.availability}%</td>
                    <td>${g.mtbf.toFixed(0)}</td>
                </tr>
            `).join('');
                }

                // --- HELPERS ---
                function renderKPIs(containerId, groups) {
                    if (!groups.length) return;

                    // Calc Averages/Sums
                    const totalCost = groups.reduce((s, g) => s + g.cost, 0);
                    const avgAvail = groups.reduce((s, g) => s + g.availability, 0) / groups.length;
                    const sumFailures = groups.reduce((s, g) => s + g.failures, 0);

                    const html = `
                <div class="kpi-card-mini">
                    <div class="kpi-val-mini" style="color: #4caf50">${avgAvail.toFixed(1)}%</div>
                    <div class="kpi-lbl-mini">Disponibilidad Prom.</div>
                </div>
                <div class="kpi-card-mini">
                    <div class="kpi-val-mini" style="color: #f44336">$${totalCost.toLocaleString()}</div>
                    <div class="kpi-lbl-mini">Gasto Total</div>
                </div>
                <div class="kpi-card-mini">
                    <div class="kpi-val-mini" style="color: #ff9800">${sumFailures}</div>
                    <div class="kpi-lbl-mini">Total Fallas</div>
                </div>
            `;
                    document.getElementById(containerId).innerHTML = html;
                }

                function renderChart(canvasId, groups, metricKey, label) {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    const labels = groups.map(g => g.name);
                    const dataVal = groups.map(g => g[metricKey]);

                    // Clean previous chart instance if exists? 
                    // We use global vars chartInstance1/2
                    if (canvasId === 'chartLevel1') {
                        if (chartInstance1) chartInstance1.destroy();
                        chartInstance1 = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: label,
                                    data: dataVal,
                                    backgroundColor: metricKey === 'cost' ? '#f44336' : '#03dac6',
                                    borderRadius: 4
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
                        });
                    } else {
                        if (chartInstance2) chartInstance2.destroy();
                        chartInstance2 = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: labels,
                                datasets: [{
                                    data: dataVal,
                                    backgroundColor: ['#e91e63', '#9c27b0', '#3f51b5', '#2196f3', '#00bcd4', '#4caf50', '#ffc107', '#ff5722']
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false }
                        });
                    }
                }
            </script>
        </div>
    </section>
    <script src="/static/js/sidebar.js"></script>
</body>

</html>